# Verify data with signature

A signature is used to verify data integrity between your system and SimplifyTrip. It is generated from `checksumKey` and request/response data fields defined by each API.

Whenever you receive data from SimplifyTrip, verify the signature to ensure payload authenticity.

Try with [Signature Generator](/signature-generator)

#### How to generate a signature

- SimplifyTrip uses [HMAC](https://en.wikipedia.org/wiki/HMAC) with [SHA-256](https://en.wikipedia.org/wiki/SHA-2).
- Signature input data format: `key1=value1&key2=value2`...
- Fields must be sorted alphabetically by key.
- Formula: `hash_hmac("sha256", data, checksum_key)`

import { Callout, Steps } from 'nextra/components'

<Callout>
  **Note** Checksum Key is generated when API key is created. You can rotate Checksum Key anytime if leakage is suspected.
</Callout>

#### Sample code to validate data

<CH.Code>
```js Nodejs
import { createHmac } from "crypto";

const checksumKey = "ck_test_xxxxxxxxxxxxxxxxxxxxxxxx";
const signature = "412e915d2871504ed31be63c8f62a149a4410d34c4c42affc9006ef9917eaa03";
const webhookData = {
	"id": "6740ce7f9d042322159bc6401",
	"type": "PURCHASE_ORDER_SUCCESS",
	"sentDate": "2024-11-24T17:42:31.424Z",
	"createdAt": "2024-11-24T17:42:31.424Z",
	"mode": "TEST_MODE",
	"data": {
		"orderId": "3248417841",
		"trackId": "06c08ae1-bfac-4f77-1213-a92f53bb15dd",
		"status": "SUCCESS",
		"items": [
			{
			"subOrderId": "674362a97cbd7ef05bc12786",
			"subTrackId": "62137526-5b53-475f-4333-4c1e83e13a28",
			"sku": "EAS5XY01GB04DPY",
			"quantity": 2,
			"type": "eSIM",
			"status": "SUCCESS",
			"eSims": [
					{
						"qrCodeContent": "LPA:1$SECSMSMINIAPP.EASTCOMPEACE.COM$502F97EF09144E0C9D62FD781E259916",
						"qrCodeImg": "https://files.simplifytrip.com/a11dd3c438f38f5383fa17c8ea2de3ef.png",
						"iccid": "89812003916820391469",
						"planAPN": "plus.4g",
						"smdpAddress": "SECSMSMINIAPP.EASTCOMPEACE.COM",
						"pin": "1234",
						"puk": "15095300",
						"activationCode": "502F97EF09144E0C9D62FD781E256862"
					},
					{
						"qrCodeContent": "LPA:1$SECSMSMINIAPP.EASTCOMPEACE.COM$502F97EF09144E0C9D62FD781E259916",
						"qrCodeImg": "https://files.simplifytrip.com/a11dd3c438f38f5383fa17c8ea2de3ef.png",
						"iccid": "89812003916820396627",
						"planAPN": "plus.4g",
						"smdpAddress": "SECSMSMINIAPP.EASTCOMPEACE.COM",
						"pin": "1234",
						"puk": "15095300",
						"activationCode": "502F97EF09144E0C9D62FD781E253495"
					}
				]
			}
		]
	},
};

function deepFlattenToObject(obj, prefix = '') {
	return Object.keys(obj).reduce((acc, k) => {
		const pre = prefix.length ? prefix + '_' : '';
		if (typeof obj[k] === 'object' && obj[k] !== null) {
			Object.assign(acc, deepFlattenToObject(obj[k], pre + k));
		} else {
			acc[pre + k] = obj[k];
		}
		return acc;
	}, {});
}

function convertObjToQueryStr(object) {
	const flatObj = deepFlattenToObject(object);

	return Object.keys(flatObj)
		.sort()
		.filter((key) => flatObj[key] !== undefined)
		.map((key) => {
			let value = flatObj[key];
			if ([null, undefined, "undefined", "null"].includes(value)) {
				value = "";
			}
			return `${key}=${value}`;
		})
		.join("&");
}

function isValidData(data, currentSignature, checksumKey) {
	const dataQueryStr = convertObjToQueryStr(data);
	const dataToSignature = createHmac("sha256", checksumKey)
	.update(dataQueryStr)
	.digest("hex");

	return dataToSignature == currentSignature;
}

return isValidData(webhookData, signature, checksumKey);
```
</CH.Code>

## Example flow

<Steps>
#### Input data
Use webhook payload and current signature.

#### Flatten object
Flatten nested object/array data into a single-level object with underscore key path.

#### Sort and stringify
Sort keys alphabetically and join as `key=value` with `&`.

#### Generate signature
Hash using `HMAC_SHA256(dataString, checksumKey)` and compare with the received signature.
</Steps>

Try with [Signature Generator](/signature-generator)
